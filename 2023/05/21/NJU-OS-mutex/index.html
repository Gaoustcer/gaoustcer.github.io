<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/bollnh/hexo-theme-material
        Version: 1.5.6 -->
    <script>
        window.materialVersion = "1.5.6"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0',
            '1.5.2',
            '1.5.5'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">





    <link rel="dns-prefetch" href="https://.disqus.com"/>





    <link rel="dns-prefetch" href="https://fonts.googleapis.com"/>





    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            NJU OS mutex | 
        
        Hexo
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.svg">
    <link rel="icon" href="/img/favicon.svg">

    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content=",NJU OS,system">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?NKhlKQkXw/c66TR5p4wO+w==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Hexo">
    <meta name="msapplication-starturl" content="http://gaoustcer.github.io/2023/05/21/NJU-OS-mutex/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Hexo">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.svg">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://gaoustcer.github.io/2023/05/21/NJU-OS-mutex/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="NJU OS mutex | Hexo">
    <meta property="og:image" content="/img/favicon.svg">
    <meta property="og:description" content="">
    <meta property="og:article:tag" content="NJU OS"> <meta property="og:article:tag" content="system"> 

    
        <meta property="article:published_time" content="Sun May 21 2023 12:15:46 GMT+0800">
        <meta property="article:modified_time" content="Sun May 21 2023 12:20:05 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://gaoustcer.github.io/2023/05/21/NJU-OS-mutex/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://gaoustcer.github.io/2023/05/21/NJU-OS-mutex/index.html",
    "headline": "NJU OS mutex",
    "datePublished": "Sun May 21 2023 12:15:46 GMT+0800",
    "dateModified": "Sun May 21 2023 12:20:05 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "Gaoustcer",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.png"
        },
        "description": "Hi, nice to meet you"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Hexo",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.svg"
        }
    },
    "keywords": ",NJU OS,system",
    "description": "",
}
</script>


    

    <!-- Analytics -->
    
    
    

    <!-- Custom Head -->
    

<meta name="generator" content="Hexo 6.3.0"></head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span id="MD-burger-id" class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#%E5%8D%97%E4%BA%AC%E5%A4%A7%E5%AD%A6%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-mutex"><span class="post-toc-number">1.</span> <span class="post-toc-text">南京大学操作系统(mutex)</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Review"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">Review</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Spin-Lock"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">Spin Lock</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#x86%E5%8E%9F%E5%AD%90%E6%93%8D%E4%BD%9C"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">x86原子操作</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%80%9F%E5%8A%A9%E5%8E%9F%E5%AD%90%E6%8C%87%E4%BB%A4%E6%8E%A7%E5%88%B6%E5%85%B1%E4%BA%AB%E5%8F%98%E9%87%8F%E8%AE%BF%E9%97%AE"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">借助原子指令控制共享变量访问</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%8E%9F%E5%AD%90%E6%8C%87%E4%BB%A4%E6%A8%A1%E5%9E%8B"><span class="post-toc-number">1.2.3.</span> <span class="post-toc-text">原子指令模型</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%AE%9E%E7%8E%B0%E7%A1%AC%E4%BB%B6%E9%94%81"><span class="post-toc-number">1.2.3.1.</span> <span class="post-toc-text">实现硬件锁</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#RISC-V%E5%AE%9E%E7%8E%B0%E5%8E%9F%E5%AD%90%E6%8C%87%E4%BB%A4"><span class="post-toc-number">1.2.3.2.</span> <span class="post-toc-text">RISC-V实现原子指令</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%BC%BA%E9%99%B7"><span class="post-toc-number">1.2.4.</span> <span class="post-toc-text">缺陷</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Fast-Path%E5%92%8CSlow-path"><span class="post-toc-number">1.2.5.</span> <span class="post-toc-text">Fast Path和Slow path</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#OS-API%E5%AE%9E%E7%8E%B0%E9%94%81%E7%9A%84%E9%87%8A%E6%94%BE%E5%92%8C%E8%BF%94%E5%9B%9E-%E7%9D%A1%E7%9C%A0%E9%94%81"><span class="post-toc-number">1.2.6.</span> <span class="post-toc-text">OS API实现锁的释放和返回(睡眠锁)</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Trade-Off"><span class="post-toc-number">1.2.7.</span> <span class="post-toc-text">Trade Off</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E8%BF%9B%E5%85%A5%E4%B8%B4%E7%95%8C%E5%8C%BA"><span class="post-toc-number">1.2.7.1.</span> <span class="post-toc-text">进入临界区</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E9%80%80%E5%87%BA%E4%B8%B4%E7%95%8C%E5%8C%BA"><span class="post-toc-number">1.2.7.2.</span> <span class="post-toc-text">退出临界区</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Note-of-awk"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">Note of awk</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%A8%A1%E5%BC%8F"><span class="post-toc-number">1.3.1.</span> <span class="post-toc-text">模式</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%93%8D%E4%BD%9C"><span class="post-toc-number">1.3.2.</span> <span class="post-toc-text">操作</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E9%A2%84%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="post-toc-number">1.3.3.</span> <span class="post-toc-text">预定义变量</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%BC%A0%E9%80%92%E5%A4%96%E9%83%A8%E5%8F%98%E9%87%8F"><span class="post-toc-number">1.3.4.</span> <span class="post-toc-text">传递外部变量</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="post-toc-number">1.3.5.</span> <span class="post-toc-text">正则表达式</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%89%93%E5%8D%B0%E6%96%87%E6%9C%AC%E7%AC%ACi%E5%88%97"><span class="post-toc-number">1.3.6.</span> <span class="post-toc-text">打印文本第i列</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#C%E5%A4%84%E7%90%86%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%8F%82%E6%95%B0getopt"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">C处理命令行参数getopt</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#getopt-long"><span class="post-toc-number">1.4.1.</span> <span class="post-toc-text">getopt_long()</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96%E5%AE%9E%E7%8E%B0%E5%AF%84%E5%AD%98%E5%99%A8%E7%8E%B0%E5%9C%BA%E5%88%87%E6%8D%A2"><span class="post-toc-number">1.5.</span> <span class="post-toc-text">内联汇编实现寄存器现场切换</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%86%85%E8%81%94%E6%B1%87%E7%BC%96%E8%AF%AD%E6%B3%95"><span class="post-toc-number">1.5.1.</span> <span class="post-toc-text">内联汇编语法</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E7%8E%B0%E8%B5%8B%E5%80%BCx-y"><span class="post-toc-number">1.5.2.</span> <span class="post-toc-text">实现赋值x&#x3D;y</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E5%AD%90"><span class="post-toc-number">1.5.3.</span> <span class="post-toc-text">实现原子+</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%90%86%E8%A7%A3%E7%BA%BF%E7%A8%8B%E5%BA%93%E4%B8%AD%E7%9A%84%E4%BF%9D%E6%8A%A4%E7%8E%B0%E5%9C%BA"><span class="post-toc-number">1.5.4.</span> <span class="post-toc-text">理解线程库中的保护现场</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Constrain"><span class="post-toc-number">1.5.5.</span> <span class="post-toc-text">Constrain</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#r"><span class="post-toc-number">1.5.5.1.</span> <span class="post-toc-text">r</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#m"><span class="post-toc-number">1.5.5.2.</span> <span class="post-toc-text">m</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Digital-constraints"><span class="post-toc-number">1.5.5.3.</span> <span class="post-toc-text">Digital constraints</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E8%AF%BB%E6%96%87%E6%A1%A3setjmp-amp-amp-longjump"><span class="post-toc-number">1.6.</span> <span class="post-toc-text">读文档setjmp&amp;&amp;longjump</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Description"><span class="post-toc-number">1.6.1.</span> <span class="post-toc-text">Description</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%BF%94%E5%9B%9E%E5%80%BC"><span class="post-toc-number">1.6.2.</span> <span class="post-toc-text">返回值</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#M2"><span class="post-toc-number">1.7.</span> <span class="post-toc-text">M2</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#co-yield"><span class="post-toc-number">1.7.1.</span> <span class="post-toc-text">co_yield</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E4%BF%9D%E6%8A%A4%E5%87%BD%E6%95%B0%E5%A0%86%E6%A0%88"><span class="post-toc-number">1.7.2.</span> <span class="post-toc-text">保护函数堆栈</span></a></li></ol></li></ol></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                NJU OS mutex
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Gaoustcer</strong>
        <span>5月 21, 2023</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-none-link" href="/tags/NJU-OS/" rel="tag">NJU OS</a></li><li class="mdl-menu__item"><a class="post_tag-none-link" href="/tags/system/" rel="tag">system</a>
    </ul>
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=NJU OS mutex&url=http://gaoustcer.github.io/2023/05/21/NJU-OS-mutex/index.html&pic=http://gaoustcer.github.io/img/favicon.svg&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=NJU OS mutex&url=http://gaoustcer.github.io/2023/05/21/NJU-OS-mutex/index.html&via=Gaoustcer" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://gaoustcer.github.io/2023/05/21/NJU-OS-mutex/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://gaoustcer.github.io/2023/05/21/NJU-OS-mutex/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h1 id="南京大学操作系统-mutex"><a href="#南京大学操作系统-mutex" class="headerlink" title="南京大学操作系统(mutex)"></a>南京大学操作系统(mutex)</h1><p>practical implementation of mutex</p>
<h2 id="Review"><a href="#Review" class="headerlink" title="Review"></a>Review</h2><p>同时读写共享内存导致出现冲突</p>
<ol>
<li><em><em>过去的</em></em><em><em>过去的</em></em>**值</li>
<li>store的结果不能保证下一次load得到store的结果</li>
</ol>
<h2 id="Spin-Lock"><a href="#Spin-Lock" class="headerlink" title="Spin Lock"></a>Spin Lock</h2><p>硬件上保证store+load操作是原子的</p>
<ol>
<li>避免其它线程在某线程读写共享变量时修改共享变量</li>
<li>单一资源竞争(裁判)</li>
</ol>
<h3 id="x86原子操作"><a href="#x86原子操作" class="headerlink" title="x86原子操作"></a>x86原子操作</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lock add1 $1,(sum)</span><br></pre></td></tr></table></figure>
<h3 id="借助原子指令控制共享变量访问"><a href="#借助原子指令控制共享变量访问" class="headerlink" title="借助原子指令控制共享变量访问"></a>借助原子指令控制共享变量访问</h3><p>设置共享锁，访问共享变量前申请获得锁，只有获得锁的进程才能进入临界区</p>
<h3 id="原子指令模型"><a href="#原子指令模型" class="headerlink" title="原子指令模型"></a>原子指令模型</h3><ol>
<li>lock对所有线程可见(存在全局可见的lock顺序)</li>
<li>多处理器程序间构造序</li>
</ol>
<h4 id="实现硬件锁"><a href="#实现硬件锁" class="headerlink" title="实现硬件锁"></a>实现硬件锁</h4><p><em><em>指令前缀</em></em><em><em>指令前缀</em></em>令前缀**，译码根据前缀内容向总线发送上锁命令，由总线完成仲裁</p>
<blockquote>
<p><em><em>控制</em></em><em><em>控制</em></em>**其它核的缓存？</p>
<blockquote>
<p>所有core共享L2 cache，一条lock指令需要删除所有core cache上的对象副本</p>
</blockquote>
</blockquote>
<h4 id="RISC-V实现原子指令"><a href="#RISC-V实现原子指令" class="headerlink" title="RISC-V实现原子指令"></a>RISC-V实现原子指令</h4><p>原子指令分成三步(Read-modify-write)</p>
<ol>
<li>读入内存变量到寄存器中</li>
<li>寄存器执行运算</li>
<li>寄存器的运算写道对应内存位置</li>
</ol>
<blockquote>
<p>Load-Reserved/Store Conditional(LR/SC)</p>
<p><em><em>打标记(load reserved，load link)</em></em>nk)**，再读入共享变量到局部寄存器，进行本地计算，随后写入到内存需要满足Store Conditional，即操作的共享变量上仍然有这个标记才能进行写操作</p>
<p>多个load reseved产生并发写入，导致标记消失，此时需要重新打标记再次写入</p>
<p>compare-and-swap</p>
<ol>
<li>读入内存(<code>lr w</code>)</li>
<li>判断内存是否等于给定值(<code>bne</code>)</li>
<li>满足条件，则执行操作(写入新值)<code>sc,w</code></li>
<li>判断写入是否成功执行</li>
</ol>
<blockquote>
<p>写入未完成，则代表锁拥堵（多个进程并发操作）</p>
</blockquote>
</blockquote>
<h3 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h3><ol>
<li>原子操作必须保证指令乱序</li>
<li>多个线程只有一个线程在工作，其他线程在死循环<ol>
<li>分时多线程，抢到锁的线程被切换出去了。。</li>
<li>多线程并不能提升性能(空等)</li>
</ol>
</li>
</ol>
<blockquote>
<ol>
<li>几乎只有一个进程会在某一时刻</li>
<li>避免进程切换(内核程序，避免中断)</li>
</ol>
</blockquote>
<h3 id="Fast-Path和Slow-path"><a href="#Fast-Path和Slow-path" class="headerlink" title="Fast Path和Slow path"></a>Fast Path和Slow path</h3><ol>
<li>只有一个进程竞争锁(Fast Path)，Spin lock的代价只是一条原子指令+判断</li>
<li>多个进程等待(Slow Path)</li>
</ol>
<h3 id="OS-API实现锁的释放和返回-睡眠锁"><a href="#OS-API实现锁的释放和返回-睡眠锁" class="headerlink" title="OS API实现锁的释放和返回(睡眠锁)"></a>OS API实现锁的释放和返回(睡眠锁)</h3><p><code>SYSCALL_lock</code>获得锁</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syscall(SYSCALL_lock,&amp;lck)</span><br></pre></td></tr></table></figure>
<p><em><em>否则将自己切换出去</em></em><em><em>否则将自己切换出去</em></em>则将自己切换出去**</p>
<p><code>SySCALL_unlock</code>释放锁</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">syscall(SYSCALL_unlock,&amp;lck)</span><br></pre></td></tr></table></figure>
<p><em><em>唤醒因等待lck而sleep的进程</em></em>eep的进程**</p>
<blockquote>
<p>需要为每个锁维护一个等待队列，相比Spin lock提高了Fast Path开销(需要进入内核)</p>
</blockquote>
<h3 id="Trade-Off"><a href="#Trade-Off" class="headerlink" title="Trade Off"></a>Trade Off</h3><h4 id="进入临界区"><a href="#进入临界区" class="headerlink" title="进入临界区"></a>进入临界区</h4><ol>
<li>获得锁(单步原子指令，对内存用户态的锁进行fetch)</li>
<li>成功则进入临界区</li>
<li>失败进入系统调用，插入等待队列</li>
</ol>
<h4 id="退出临界区"><a href="#退出临界区" class="headerlink" title="退出临界区"></a>退出临界区</h4><p>所有退出临界区的进程都需要进入系统调用唤醒队列中的等待进程</p>
<h2 id="Note-of-awk"><a href="#Note-of-awk" class="headerlink" title="Note of awk"></a>Note of awk</h2><p>awk由模式和操作组成</p>
<h3 id="模式"><a href="#模式" class="headerlink" title="模式"></a>模式</h3><ol>
<li>正则表达式</li>
<li>关系表达式</li>
<li>模式匹配表达式 <code>~</code>匹配 <code>!~</code>不匹配</li>
<li>BEGIN pattern END 语句块</li>
</ol>
<h3 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h3><ol>
<li>变量数组赋值</li>
<li>输出命令</li>
<li>内置函数</li>
<li>控制流</li>
</ol>
<p>例子</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk &#x27;BEGIN &#123;print &quot;start&quot;&#125; pattern&#123; commands&#125; END&#123;print &quot;end&quot;&#125;&#x27; file</span><br></pre></td></tr></table></figure>
<p>脚本在单引号中</p>
<p>工作原理</p>
<ol>
<li>执行<code>BEGIN &#123;commands&#125;</code>语句</li>
<li>文件或标准输入读取一行，执行<code>pattern&#123;commands&#125;</code></li>
<li>执行到输入流末尾，执行<code>END&#123;commands&#125;</code></li>
</ol>
<h3 id="预定义变量"><a href="#预定义变量" class="headerlink" title="预定义变量"></a>预定义变量</h3><ol>
<li>$\$ n$当前记录的第n个字段，从1开始</li>
<li>$\$ 0$执行过程中当前行文本内容</li>
<li>NR记录项</li>
</ol>
<p>求解第一列所有元素和</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk &#x27;BEGIN &#123;sum = 0&#125; &#123;sum += $1&#125; END&#123;print sum&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="传递外部变量"><a href="#传递外部变量" class="headerlink" title="传递外部变量"></a>传递外部变量</h3><p>-v选项可以将外部变量传递给awk，例如</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let var=10000</span><br><span class="line">awk -v VARIABLE=$var &#x27;&#123;print VARIABLE&#125;&#x27;</span><br></pre></td></tr></table></figure>
<h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h3><ol>
<li>$.$匹配任意一个字符</li>
<li><code>a*</code>匹配任意个a</li>
<li><code>[^ab]</code>匹配除了ab以外的任意字符</li>
<li><code>^</code>匹配行首</li>
<li>$匹配行尾</li>
</ol>
<h3 id="打印文本第i列"><a href="#打印文本第i列" class="headerlink" title="打印文本第i列"></a>打印文本第i列</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk &#x27;&#123;print $1&#125;&#x27; filename</span><br></pre></td></tr></table></figure>
<p>比较，满足条件则打印</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk &#x27;&#123;if($5&gt;20) &#123;print $1&#125;&#125;&#x27; filename</span><br></pre></td></tr></table></figure>
<p>如果第5列大于20则打印对应行的第1列，打印也可以用printf，例如以字符串形式打印第一列</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">awk &#x27;&#123;printf &quot;%s\n&quot;,$1&#125;&#x27; filename</span><br></pre></td></tr></table></figure>
<h2 id="C处理命令行参数getopt"><a href="#C处理命令行参数getopt" class="headerlink" title="C处理命令行参数getopt"></a>C处理命令行参数getopt</h2><p>函数定义为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">getopt</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> * <span class="type">const</span> argv[], <span class="type">const</span> <span class="type">char</span> *optstring)</span>;</span><br></pre></td></tr></table></figure>
<p>第三个参数是命令行参数选项，字符代表选项</p>
<ol>
<li>只有字符没有冒号：纯选项，无需参数</li>
<li>一个冒号：选项必须有参数，可以使用空格分割选项和参数，无参数则解析失败</li>
<li>两个冒号：参数缺省</li>
</ol>
<p>例如<code>vha:b:c::</code>表示支持<code>-v,-h</code>选项(无需参数)，支持<code>-a</code>选项并带一个参数，支持<code>-c</code>选项可以缺省参数</p>
<p>解析参数的结果存在全局变量中，维护四个全局变量</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">char</span> * oprarg;<span class="comment">// 存放选项参数字符串</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> optind; <span class="comment">// 下一个检索位置，可以用argv[optind-1]遍历当前解析的命令行参数字段</span></span><br></pre></td></tr></table></figure>
<p>通过while循环遍历所有命令行参数，直到返回-1</p>
<h3 id="getopt-long"><a href="#getopt-long" class="headerlink" title="getopt_long()"></a>getopt_long()</h3><p>接收长选项，通过设置一个结构体<code>struct option</code>实现，参数是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">getopt_long</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span> * <span class="type">const</span> argv[],<span class="type">const</span> <span class="type">char</span> *optsring,<span class="type">const</span> <span class="keyword">struct</span> option * longopts,<span class="type">int</span> *longindex)</span>;</span><br></pre></td></tr></table></figure>
<ol>
<li>optstring 用于接收短选项，只接受短选项则将longopts设置为NULL即可(貌似这个选项不能设置为NULL)</li>
<li>长选项个数可以是<code>--arg=param</code>或<code>--arg param</code></li>
<li>longopts指向struct option数组第一个元素</li>
<li>longindex返回longopts数组元素位置指针(有多少个长选项)</li>
<li>参数存在问题返回<code>?</code></li>
</ol>
<p>option结构体包含</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">option</span>&#123;</span></span><br><span class="line">    <span class="type">const</span> <span class="type">char</span> *name; <span class="comment">// 选项名</span></span><br><span class="line">    <span class="type">int</span> has_args; <span class="comment">// 是否带参数 0-不带参数 1-必须带参数 2-参数可选</span></span><br><span class="line">    <span class="type">int</span> *flag; <span class="comment">// 决定getopt_long返回值类型，flag == NULL一维识别选项后返回val，否则返回0，flag设置为指向val的变量</span></span><br><span class="line">    <span class="type">int</span> val;<span class="comment">// 返回值(长命令的短缩写)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>longopts</code>数组最后一个元素需要全0填充</p>
<h2 id="内联汇编实现寄存器现场切换"><a href="#内联汇编实现寄存器现场切换" class="headerlink" title="内联汇编实现寄存器现场切换"></a>内联汇编实现寄存器现场切换</h2><h3 id="内联汇编语法"><a href="#内联汇编语法" class="headerlink" title="内联汇编语法"></a>内联汇编语法</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">__asm__(assembler template </span><br><span class="line">	: output operands                  /* optional */</span><br><span class="line">	: input operands                   /* optional */</span><br><span class="line">	: list of clobbered registers      /* optional */</span><br><span class="line">	);</span><br></pre></td></tr></table></figure>
<ol>
<li>assemble template 汇编指令</li>
<li>output operand 指示汇编指令的计算结果输出到那个C操作数中(左值)</li>
<li>input operands 指示汇编指令操作数来自哪些C操作数</li>
<li>list of register表示汇编指令修改的寄存器列表</li>
</ol>
<h3 id="实现赋值x-y"><a href="#实现赋值x-y" class="headerlink" title="实现赋值x=y"></a>实现赋值<code>x=y</code></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">asm (&quot;movl %1, %%eax; </span><br><span class="line">             movl %%eax, %0;&quot;</span><br><span class="line">            :&quot;=r&quot;(b)        /* output */</span><br><span class="line">            :&quot;r&quot;(a)         /* input */</span><br><span class="line">            :&quot;%eax&quot;         /* clobbered register */</span><br><span class="line">            );       </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li>b是输出操作数，对应第二条汇编中movl指令的目的操作数，用%0refer</li>
<li>a是输入操作数，用%1refer</li>
<li>%%用于确定操作数来自真正的寄存器</li>
<li><code>=r,r</code>称为constrain，意思是存到寄存器/从寄存器中load，m代表操作数来自memory</li>
</ol>
<h3 id="实现原子"><a href="#实现原子" class="headerlink" title="实现原子+"></a>实现原子+</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__asm__ __volatile__(</span><br><span class="line">                     &quot;   lock       ;\n&quot;</span><br><span class="line">                     &quot;   addl %1,%0 ;\n&quot;</span><br><span class="line">                     : &quot;=m&quot;  (my_var)</span><br><span class="line">                     : &quot;ir&quot;  (my_int), &quot;m&quot; (my_var)</span><br><span class="line">                     :                                 /* no clobber-list */</span><br><span class="line">                     );</span><br></pre></td></tr></table></figure>
<p>等效于计算<code>my_var = my_int+my_var</code>，<code>lock</code>是指令前缀，满足</p>
<ol>
<li>修饰的指令不能被中断打断，实现需要锁住变量对应的cache line，只有执行这一指令的线程可以存取cache line，其余core需要直接从内存读取(变量存储在单一cache line的情况)</li>
<li>内存屏障，写对象一定刷新到内存</li>
</ol>
<p>不会改变寄存器值</p>
<h3 id="理解线程库中的保护现场"><a href="#理解线程库中的保护现场" class="headerlink" title="理解线程库中的保护现场"></a>理解线程库中的保护现场</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;movq %0, %%rsp; movq %2, %%rdi; jmp *%1&quot;</span><br><span class="line">  : : &quot;b&quot;((uintptr_t)sp), &quot;d&quot;(entry), &quot;a&quot;(arg) : &quot;memory&quot;</span><br></pre></td></tr></table></figure>
<p>实现了栈帧切换、传递参数并执行函数调用，指定操作数</p>
<ol>
<li>%0 (uint_ptr_t)sp栈帧指针</li>
<li>%1 entry 入口地址</li>
<li>%2 args 参数，赋值给%rdi(reserved用于参数传递)</li>
</ol>
<p>b,d,a制定了操作数加载的寄存器，<code>jmp *%1</code>表示跳转到寄存器间接存储的内存位置，x86堆栈需要按照16字节对齐</p>
<h3 id="Constrain"><a href="#Constrain" class="headerlink" title="Constrain"></a>Constrain</h3><h4 id="r"><a href="#r" class="headerlink" title="r"></a><code>r</code></h4><p>目标操作数写道寄存器中，寄存器值加载到内存对象中，可以指定使用的寄存器</p>
<p><img src="https://s2.loli.net/2023/03/29/4IKgXHwGV2bPQei.png" alt="image-20230329104904099"></p>
<h4 id="m"><a href="#m" class="headerlink" title="m"></a><code>m</code></h4><p>直接对内存对象操作</p>
<h4 id="Digital-constraints"><a href="#Digital-constraints" class="headerlink" title="Digital constraints"></a>Digital constraints</h4><p>数据可能既作为输入也是输出，通过数字指定操作符</p>
<h2 id="读文档setjmp-amp-amp-longjump"><a href="#读文档setjmp-amp-amp-longjump" class="headerlink" title="读文档setjmp&amp;&amp;longjump"></a>读文档<code>setjmp&amp;&amp;longjump</code></h2><h3 id="Description"><a href="#Description" class="headerlink" title="Description"></a>Description</h3><p>函数用于实现nonlocal goto，即控制流从一个函数转移到另一个函数某个位置</p>
<p><code>setjmp(jmp_buf)</code>接收一个<code>jmp_buf</code>参数，预定义一个跳转目标，这个函数保存了调用处的运行时状态，包括</p>
<ol>
<li>stack pointer</li>
<li>instruction point</li>
<li>values of register</li>
<li>signal mask</li>
</ol>
<p><em><em>忽略</em></em><em><em>忽略</em></em><em><em>忽略</em></em>略**某些信号，这也是运行时信息的一部分</p>
<p><code>longjmp(jmp_buf,int)</code>用于将控制权传递给setjmp调用处并恢复调用处运行时环境(restor the stack to its state at the time of the setjmp)</p>
<h3 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h3><p><code>setjmp</code>直接调用时返回0，在fake goto的情形返回指定的参数val</p>
<h2 id="M2"><a href="#M2" class="headerlink" title="M2"></a>M2</h2><p><code>co_yield</code>选择线程切换，选择的线程有两种情况</p>
<ol>
<li>协程新创建，此时需要切换堆栈，再执行代码</li>
<li>yield切换出的协程已经通过setjmp保存寄存器，直接调用<code>longjmp</code>恢复寄存器现场</li>
</ol>
<h3 id="co-yield"><a href="#co-yield" class="headerlink" title="co_yield"></a><code>co_yield</code></h3><p>决定协程何时释放执行流，yield之前需要用<code>setjmp</code>保存寄存器现场</p>
<h3 id="保护函数堆栈"><a href="#保护函数堆栈" class="headerlink" title="保护函数堆栈"></a>保护函数堆栈</h3><p>需要在用户态保存函数堆栈，即再co结构体中维护一个数组</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">co</span>&#123;</span></span><br><span class="line">    <span class="type">uint8_t</span> <span class="built_in">stack</span>[STACK_SIZE + <span class="number">1</span>];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>还需要保存函数指针和参数</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *arg;</span><br><span class="line"><span class="type">void</span> (*func)(<span class="type">void</span> *);</span><br></pre></td></tr></table></figure>
<p>维护协程状态，用于<code>co_wait</code>等待目标协程执行结束或者唤醒方式</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">co_status</span> <span class="title">status</span>;</span></span><br></pre></td></tr></table></figure>
<p>维护唤醒队列</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">co</span> *<span class="title">waiter</span>;</span></span><br></pre></td></tr></table></figure>
<p>同时需要维护一个current指针，指向当前运行的协程(用于协程切换)</p>

        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
    <!-- 使用 DISQUS -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://gaoustcer.github.io/2023/05/21/NJU-OS-mutex/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://gaoustcer.github.io/2023/05/21/NJU-OS-mutex/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>
<script type="text/ls-javascript" id="disqus-thread-script">
    queue.offer(function() {
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document;
                var s = d.createElement('script');
                s.src = '//.disqus.com/embed.js';
                s.setAttribute('data-timestamp', + new Date());
                (d.head || d.body).appendChild(s);
            })();
        });
</script>

</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>

                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2023/05/21/NJU-OS-Parallel-Programming/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2023/05/12/Conservative-Q-Learning/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="Gaoustcer's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        kd193104@mail.ustc.edu.cn
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2023/06/">六月 2023<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2023/05/">五月 2023<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2023/04/">四月 2023<span class="sidebar_archives-count">23</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    
        <li>
            <a href="/about" title="About">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                About
            </a>
        </li>
        
    
        <li>
            <a href="/papers" title="papers">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                papers
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">32</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/bollnh/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-facebook">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    

    <!-- V2EX -->
    

    <!-- Segmentfault -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;<span year></span>&nbsp;Hexo
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/bollnh/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?Bn9UzEm8RrBSxqyZB0zPjA==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>









   <!-- 使用 DISQUS js 代码 -->
<script id="dsq-count-scr" src="//.disqus.com/count.js" async></script>





<!-- UC Browser Compatible -->
<!-- <script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('
<link rel="stylesheet" href="/css/uc.css">
');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script> -->

<!-- Import prettify js  -->



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    var copyrightNow = new Date().getFullYear();
    var textContent = document.querySelector('span[year]')

    copyrightSince = 0000;
    if (copyrightSince === copyrightNow||copyrightSince === 0000) {
        textContent.textContent = copyrightNow
    } else {
        textContent.textContent = copyrightSince + ' - ' + copyrightNow
    }

    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.6 | https://github.com/bollnh/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
