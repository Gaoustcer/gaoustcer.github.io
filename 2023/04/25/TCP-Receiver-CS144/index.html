<!DOCTYPE html>
<html style="display: none;" lang="zh">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/bollnh/hexo-theme-material
        Version: 1.5.6 -->
    <script>
        window.materialVersion = "1.5.6"
        // Delete localstorage with these tags
        window.oldVersion = [
            'codestartv1',
            '1.3.4',
            '1.4.0',
            '1.4.0b1',
            '1.5.0',
            '1.5.2',
            '1.5.5'
        ]
    </script>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">





    <link rel="dns-prefetch" href="https://.disqus.com"/>





    <link rel="dns-prefetch" href="https://fonts.googleapis.com"/>





    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">

    <!-- Title -->
    
    <title>
        
            TCP Receiver CS144 | 
        
        Hexo
    </title>

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.svg">
    <link rel="icon" href="/img/favicon.svg">

    <meta name="format-detection" content="telephone=no"/>
    <meta name="description" itemprop="description" content="">
    <meta name="keywords" content=",Computer Network,CS144">
    <meta name="theme-color" content="#0097A7">

    <!-- Disable Fucking Bloody Baidu Tranformation -->
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.zhCN.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(a){try{localStorage.removeItem(a)}catch(b){}};lsloader.setLS=function(a,c){try{localStorage.setItem(a,c)}catch(b){}};lsloader.getLS=function(a){var c="";try{c=localStorage.getItem(a)}catch(b){c=""}return c};versionString="/*"+(window.materialVersion||"unknownVersion")+"*/";lsloader.clean=function(){try{var b=[];for(var a=0;a<localStorage.length;a++){b.push(localStorage.key(a))}b.forEach(function(e){var f=lsloader.getLS(e);if(window.oldVersion){var d=window.oldVersion.reduce(function(g,h){return g||f.indexOf("/*"+h+"*/")!==-1},false);if(d){lsloader.removeLS(e)}}})}catch(c){}};lsloader.clean();lsloader.load=function(f,a,b,d){if(typeof b==="boolean"){d=b;b=undefined}d=d||false;b=b||function(){};var e;e=this.getLS(f);if(e&&e.indexOf(versionString)===-1){this.removeLS(f);this.requestResource(f,a,b,d);return}if(e){var c=e.split(versionString)[0];if(c!=a){console.log("reload:"+a);this.removeLS(f);this.requestResource(f,a,b,d);return}e=e.split(versionString)[1];if(d){this.jsRunSequence.push({name:f,code:e});this.runjs(a,f,e)}else{document.getElementById(f).appendChild(document.createTextNode(e));b()}}else{this.requestResource(f,a,b,d)}};lsloader.requestResource=function(b,e,a,c){var d=this;if(c){this.iojs(e,b,function(h,f,g){d.setLS(f,h+versionString+g);d.runjs(h,f,g)})}else{this.iocss(e,b,function(f){document.getElementById(b).appendChild(document.createTextNode(f));d.setLS(b,e+versionString+f)},a)}};lsloader.iojs=function(d,b,g){var a=this;a.jsRunSequence.push({name:b,code:""});try{var f=new XMLHttpRequest();f.open("get",d,true);f.onreadystatechange=function(){if(f.readyState==4){if((f.status>=200&&f.status<300)||f.status==304){if(f.response!=""){g(d,b,f.response);return}}a.jsfallback(d,b)}};f.send(null)}catch(c){a.jsfallback(d,b)}};lsloader.iocss=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.iofonts=function(f,c,h,a){var b=this;try{var g=new XMLHttpRequest();g.open("get",f,true);g.onreadystatechange=function(){if(g.readyState==4){if((g.status>=200&&g.status<300)||g.status==304){if(g.response!=""){h(g.response);a();return}}b.cssfallback(f,c,a)}};g.send(null)}catch(d){b.cssfallback(f,c,a)}};lsloader.runjs=function(f,c,e){if(!!c&&!!e){for(var b in this.jsRunSequence){if(this.jsRunSequence[b].name==c){this.jsRunSequence[b].code=e}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var a=document.createElement("script");a.appendChild(document.createTextNode(this.jsRunSequence[0].code));a.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(a);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else{if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var d=this;var a=document.createElement("script");a.src=this.jsRunSequence[0].path;a.type="text/javascript";this.jsRunSequence[0].status="loading";a.onload=function(){d.jsRunSequence.shift();if(d.jsRunSequence.length>0){d.runjs()}};document.body.appendChild(a)}}};lsloader.tagLoad=function(b,a){this.jsRunSequence.push({name:a,code:"",path:b,status:"failed"});this.runjs()};lsloader.jsfallback=function(c,b){if(!!this.jsnamemap[b]){return}else{this.jsnamemap[b]=b}for(var a in this.jsRunSequence){if(this.jsRunSequence[a].name==b){this.jsRunSequence[a].code="";this.jsRunSequence[a].status="failed";this.jsRunSequence[a].path=c}}this.runjs()};lsloader.cssfallback=function(e,c,b){if(!!this.cssnamemap[c]){return}else{this.cssnamemap[c]=1}var d=document.createElement("link");d.type="text/css";d.href=e;d.rel="stylesheet";d.onload=d.onerror=b;var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(d,a)};lsloader.runInlineScript=function(c,b){var a=document.getElementById(b).innerText;this.jsRunSequence.push({name:c,code:a});this.runjs()}})();</script>

    <!-- Import queue -->
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Import CSS -->
    
        <style id="material_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_css","/css/material.min.css?Z7a72R1E4SxzBKR/WGctOA==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>
        <style id="style_css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("style_css","/css/style.min.css?NKhlKQkXw/c66TR5p4wO+w==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>

        

    

    

    <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
    overflow-x: hidden !important;
  }
  
  code {
    font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->
<!-- Import Roboto -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">


<!-- Import Material Icons -->


    <style id="material_icons"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("material_icons","/css/material-icons.css?pqhB/Rd/ab0H2+kZp0RDmw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";}, false)</script>




    <!-- Import jQuery -->
    
        <script>lsloader.load("jq_js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==", true)</script>
    

    <!-- WebAPP Icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Hexo">
    <meta name="msapplication-starturl" content="http://gaoustcer.github.io/2023/04/25/TCP-Receiver-CS144/">
    <meta name="msapplication-navbutton-color" content="#0097A7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Hexo">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon" href="/img/favicon.svg">

    <!-- Site Verification -->
    
    

    <!-- RSS -->
    

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://gaoustcer.github.io/2023/04/25/TCP-Receiver-CS144/">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="TCP Receiver CS144 | Hexo">
    <meta property="og:image" content="/img/favicon.svg">
    <meta property="og:description" content="">
    <meta property="og:article:tag" content="Computer Network"> <meta property="og:article:tag" content="CS144"> 

    
        <meta property="article:published_time" content="Tue Apr 25 2023 10:37:30 GMT+0800">
        <meta property="article:modified_time" content="Tue Apr 25 2023 10:43:44 GMT+0800">
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:card" content="summary_large_image">

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://gaoustcer.github.io/2023/04/25/TCP-Receiver-CS144/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage": "http://gaoustcer.github.io/2023/04/25/TCP-Receiver-CS144/index.html",
    "headline": "TCP Receiver CS144",
    "datePublished": "Tue Apr 25 2023 10:37:30 GMT+0800",
    "dateModified": "Tue Apr 25 2023 10:43:44 GMT+0800",
    "author": {
        "@type": "Person",
        "name": "Gaoustcer",
        "image": {
            "@type": "ImageObject",
            "url": "/img/avatar.png"
        },
        "description": "Hi, nice to meet you"
    },
    "publisher": {
        "@type": "Organization",
        "name": "Hexo",
        "logo": {
            "@type":"ImageObject",
            "url": "/img/favicon.svg"
        }
    },
    "keywords": ",Computer Network,CS144",
    "description": "",
}
</script>


    

    <!-- Analytics -->
    
    
    

    <!-- Custom Head -->
    

<meta name="generator" content="Hexo 6.3.0"></head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span id="MD-burger-id" class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->


    <!-- Left aligned menu below button -->
    
    
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#CS144-Lab2%E5%AE%9E%E7%8E%B0TCP-receiver"><span class="post-toc-number">1.</span> <span class="post-toc-text">CS144 Lab2实现TCP receiver</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#%E5%8F%AF%E9%9D%A0%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93"><span class="post-toc-number">1.1.</span> <span class="post-toc-text">可靠数据传输</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%80%9F%E5%8A%A9%E4%B8%8D%E5%8F%AF%E9%9D%A0%E4%B8%8B%E5%B1%82%E5%8D%8F%E8%AE%AE%E5%AE%9E%E7%8E%B0%E5%8F%AF%E9%9D%A0%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93"><span class="post-toc-number">1.1.1.</span> <span class="post-toc-text">借助不可靠下层协议实现可靠数据传输</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%88%A4%E6%96%AD%E6%95%B0%E6%8D%AE%E5%8C%85%E4%B8%A2%E5%A4%B1"><span class="post-toc-number">1.1.2.</span> <span class="post-toc-text">判断数据包丢失</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%8A%A0%E9%80%9F"><span class="post-toc-number">1.1.3.</span> <span class="post-toc-text">流水线加速</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%B5%81%E6%B0%B4%E7%BA%BF%E5%B7%AE%E9%94%99%E6%81%A2%E5%A4%8D%E2%80%94%E2%80%94%E5%9B%9E%E9%80%80"><span class="post-toc-number">1.1.3.1.</span> <span class="post-toc-text">流水线差错恢复——回退</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%94%B9%E8%BF%9B"><span class="post-toc-number">1.1.3.2.</span> <span class="post-toc-text">改进</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#TCP-Protocol"><span class="post-toc-number">1.2.</span> <span class="post-toc-text">TCP Protocol</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E6%8A%A5%E6%96%87%E7%BB%93%E6%9E%84"><span class="post-toc-number">1.2.1.</span> <span class="post-toc-text">报文结构</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%B6%85%E6%97%B6%E5%92%8CRTT%E4%BC%B0%E8%AE%A1"><span class="post-toc-number">1.2.2.</span> <span class="post-toc-text">超时和RTT估计</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8F%AF%E9%9D%A0%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93"><span class="post-toc-number">1.2.3.</span> <span class="post-toc-text">实现可靠数据传输</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E8%B6%85%E6%97%B6%E6%97%B6%E9%97%B4"><span class="post-toc-number">1.2.3.1.</span> <span class="post-toc-text">超时时间</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%BF%AB%E9%80%9F%E9%87%8D%E4%BC%A0"><span class="post-toc-number">1.2.3.2.</span> <span class="post-toc-text">快速重传</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E5%B7%AE%E9%94%99%E6%81%A2%E5%A4%8D"><span class="post-toc-number">1.2.3.3.</span> <span class="post-toc-text">差错恢复</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%B5%81%E9%87%8F%E6%8E%A7%E5%88%B6"><span class="post-toc-number">1.2.3.4.</span> <span class="post-toc-text">流量控制</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5"><span class="post-toc-number">1.2.4.</span> <span class="post-toc-text">建立连接</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#TCP%E5%88%86%E6%AE%B5MSS"><span class="post-toc-number">1.2.5.</span> <span class="post-toc-text">TCP分段MSS</span></a></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Lab-2-Overview"><span class="post-toc-number">1.3.</span> <span class="post-toc-text">Lab 2 Overview</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Lab2-in-details"><span class="post-toc-number">1.4.</span> <span class="post-toc-text">Lab2 in details</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="post-toc-number">1.4.1.</span> <span class="post-toc-text">名词解释</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Acknowledgement"><span class="post-toc-number">1.4.1.1.</span> <span class="post-toc-text">Acknowledgement</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Flow-control"><span class="post-toc-number">1.4.1.2.</span> <span class="post-toc-text">Flow control</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Seqno%E8%BD%AC%E6%8D%A2"><span class="post-toc-number">1.4.2.</span> <span class="post-toc-text">Seqno转换</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%AE%9E%E7%8E%B0TCP-receiver"><span class="post-toc-number">1.4.3.</span> <span class="post-toc-text">实现TCP receiver</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Interface"><span class="post-toc-number">1.4.3.1.</span> <span class="post-toc-text">Interface</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E6%8E%A5%E6%94%B6%E5%AD%97%E8%8A%82%E6%B5%81segment-received"><span class="post-toc-number">1.4.3.2.</span> <span class="post-toc-text">接收字节流segment_received()</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ackno"><span class="post-toc-number">1.4.3.3.</span> <span class="post-toc-text">ackno()</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#window-size"><span class="post-toc-number">1.4.3.4.</span> <span class="post-toc-text">window_size()</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#Receiver%E7%8A%B6%E6%80%81"><span class="post-toc-number">1.4.4.</span> <span class="post-toc-text">Receiver状态</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E5%9D%91"><span class="post-toc-number">1.4.5.</span> <span class="post-toc-text">坑</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#SYN%E9%9C%80%E8%A6%81%E5%8D%A0%E6%8D%AE%E4%B8%80%E4%B8%AAByte"><span class="post-toc-number">1.4.5.1.</span> <span class="post-toc-text">SYN需要占据一个Byte</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E8%B0%83%E7%94%A8unwrap%E5%92%8Cwrap"><span class="post-toc-number">1.4.5.2.</span> <span class="post-toc-text">调用unwrap和wrap</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#TCP-window"><span class="post-toc-number">1.4.6.</span> <span class="post-toc-text">TCP window</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%8E%B7%E5%8F%96Header%E4%BF%A1%E6%81%AF"><span class="post-toc-number">1.4.7.</span> <span class="post-toc-text">获取Header信息</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E8%AE%BE%E8%AE%A1"><span class="post-toc-number">1.4.8.</span> <span class="post-toc-text">设计</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#%E7%BB%B4%E6%8A%A4%E5%8F%91%E9%80%81%E5%AD%97%E6%AE%B5%E7%9A%84%E5%BA%8F%E5%88%97%E5%8F%B7"><span class="post-toc-number">1.4.8.1.</span> <span class="post-toc-text">维护发送字段的序列号</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#%E7%BB%B4%E6%8A%A4receiver%E7%8A%B6%E6%80%81"><span class="post-toc-number">1.4.9.</span> <span class="post-toc-text">维护receiver状态</span></a></li></ol></li></ol></li></ol>
    </ul>
    




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                TCP Receiver CS144
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>Gaoustcer</strong>
        <span>4月 25, 2023</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-none-link" href="/tags/CS144/" rel="tag">CS144</a></li><li class="mdl-menu__item"><a class="post_tag-none-link" href="/tags/Computer-Network/" rel="tag">Computer Network</a>
    </ul>
    

    <!-- Share -->
    
        <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=TCP Receiver CS144&url=http://gaoustcer.github.io/2023/04/25/TCP-Receiver-CS144/index.html&pic=http://gaoustcer.github.io/img/favicon.svg&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                分享到微博
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=TCP Receiver CS144&url=http://gaoustcer.github.io/2023/04/25/TCP-Receiver-CS144/index.html&via=Gaoustcer" target="_blank">
            <li class="mdl-menu__item">
                分享到 Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://gaoustcer.github.io/2023/04/25/TCP-Receiver-CS144/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://gaoustcer.github.io/2023/04/25/TCP-Receiver-CS144/index.html" target="_blank">
            <li class="mdl-menu__item">
                分享到 Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

    
</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h1 id="CS144-Lab2实现TCP-receiver"><a href="#CS144-Lab2实现TCP-receiver" class="headerlink" title="CS144 Lab2实现TCP receiver"></a>CS144 Lab2实现TCP receiver</h1><h2 id="可靠数据传输"><a href="#可靠数据传输" class="headerlink" title="可靠数据传输"></a>可靠数据传输</h2><p>如果上层应用使用可靠数据传输和server端的某个进程通讯，那么底层信道抽象为1</p>
<ol>
<li>sender发送的数据不会在中途丢失或出错</li>
<li>可靠应用传输信道给上层应用传递的数据是有序的</li>
</ol>
<p>在lab1中的Reassemble保证了写入Byte Stream的数据必然是有序的，TCP采用校验机制保证数据在中途没有出错</p>
<h3 id="借助不可靠下层协议实现可靠数据传输"><a href="#借助不可靠下层协议实现可靠数据传输" class="headerlink" title="借助不可靠下层协议实现可靠数据传输"></a>借助不可靠下层协议实现可靠数据传输</h3><blockquote>
<p>如何理解可靠数据传输协议的下层协议是不可靠的？如何依靠一个不可靠的下层协议实现可靠数据传输？</p>
<blockquote>
<ol>
<li>数据重传(上层协议发现下层协议并没有给它正确的包，命令下层协议再次传输数据包)</li>
<li>确认收到/否认收到</li>
</ol>
</blockquote>
<p>基于以上策略的可靠数据传输称为自动重传请求(ARQ)，带来的问题是：确认重传的报文也可能丢失，如果sender收到错误的/未收到ACK消息，将会重传报文，这将导致报文冗余</p>
</blockquote>
<h3 id="判断数据包丢失"><a href="#判断数据包丢失" class="headerlink" title="判断数据包丢失"></a>判断数据包丢失</h3><p>等待一定时间以确定报文是否丢失</p>
<blockquote>
<p>某些分组延迟大于timeout，则也会导致荣誉分组</p>
</blockquote>
<p>序列号是为了解决冗余分组告知receiver每个报文起始字节在总字节序中的位置</p>
<h3 id="流水线加速"><a href="#流水线加速" class="headerlink" title="流水线加速"></a>流水线加速</h3><p><em><em>sender发送连续的多个报文，无需等待来自receiver的ACK</em></em><em><em>sender发送连续的多个报文，无需等待来自receiver的ACK</em></em><em><em>sender发送连续的多个报文，无需等待来自receiver的ACK</em></em>er的ACK**。发送者和接收者需要缓存流水线中的多个报文以便处理乱序或者重传的情况</p>
<h4 id="流水线差错恢复——回退"><a href="#流水线差错恢复——回退" class="headerlink" title="流水线差错恢复——回退"></a>流水线差错恢复——回退</h4><blockquote>
<p>流水线中未确认的分组数不能超过N</p>
</blockquote>
<p>分组按照需要分成四类</p>
<ol>
<li>[0,base-1]已经被发送，并且已经被接收的分组号</li>
<li>[base,nextseqnum-1]已经被发送，未被确认的分组</li>
<li>[nextseqnum,base+N-1]维护一个大小为N的窗口，这部分属于窗口中尚未被发送的分组</li>
<li><em><em>准备发送</em></em><em><em>准备发送</em></em><em><em>准备发送</em></em><em><em>准备发送</em></em>**状态</li>
</ol>
<p>收到一个ACK，采取累计确认的策略移动滑动窗口</p>
<p><em><em><em><em>时才会向sender发送ACK，即接收方接收到</em></em>送ACK，即接收方接收到**超前</em></em><em><em>超前</em></em>前**的乱序包则会发送最近的按序收到的分组ACK</p>
<blockquote>
<p>当前已经接收了分组1，2，3，分组4丢失，分组5到达，则receiver会发送ACK3给sender</p>
</blockquote>
<h4 id="改进"><a href="#改进" class="headerlink" title="改进"></a>改进</h4><p><em><em>未来</em></em>**的分组可以存下来，等到缺失的分组到达时再将缺失分组补上</p>
<blockquote>
<p>逐个确认已经正确收到的分组，缓存乱序的分组</p>
</blockquote>
<p>窗口中已发送分组可以分成三类</p>
<ol>
<li>已经收到receiver ACK确认，顺序正确的分组(已经可以被receiver交付给上层)</li>
<li>尚未收到ACK确认的分组(可能因为超时重传机制需要再次发送)</li>
<li>已经收到ACK确认的乱序分组</li>
</ol>
<h2 id="TCP-Protocol"><a href="#TCP-Protocol" class="headerlink" title="TCP Protocol"></a>TCP Protocol</h2><h3 id="报文结构"><a href="#报文结构" class="headerlink" title="报文结构"></a>报文结构</h3><ol>
<li>源/目的端口，用于交付给上层应用<ol>
<li>源地址/目标地址(用于IP协议路由器端口转发？)</li>
</ol>
</li>
<li>序号(报文首字节在整个数据段中的byte顺序)</li>
<li>确认号：接收端认为ACK之前的报文都已经被正确组装并接收(接收端期望收到的下一个字节编号)</li>
<li>首部长度(20字节)</li>
<li>标志<ol>
<li>ACK：确认号有效</li>
<li>RST,SYN,FIN建立/拆除链接</li>
<li>CWR,ECE拥塞控制</li>
</ol>
</li>
<li>接收窗口字段，用于接收方向发送方发送ACK消息是同时告知自身接收窗口大小，实现流量控制</li>
</ol>
<blockquote>
<p>发送消息-确认过程是双工的，而不是仅仅在服务端-客户端单向</p>
<p>双工意味着建立连接后服务端/客户端都可以向对方传递消息，因此需要维护相互独立的seq num</p>
</blockquote>
<h3 id="超时和RTT估计"><a href="#超时和RTT估计" class="headerlink" title="超时和RTT估计"></a>超时和RTT估计</h3><p>RTT(往返时间)由TCP维护一个RTT均值(EstimatedRTT)，获得一个Sample值按照动量更新ERTT</p>
<script type="math/tex; mode=display">
ERTT = \alpha SRTT +(1-\alpha) ERTT</script><p>RTT的变化称为RTT偏差(DRTT)，采用类似的方式进行更新</p>
<script type="math/tex; mode=display">
DRTT = (1-\beta)DRTT+\beta|SRTT-ERTT|</script><p>超时间隔定义为</p>
<script type="math/tex; mode=display">
Timeout = 4 DRTT + ERTT</script><h3 id="实现可靠数据传输"><a href="#实现可靠数据传输" class="headerlink" title="实现可靠数据传输"></a>实现可靠数据传输</h3><h4 id="超时时间"><a href="#超时时间" class="headerlink" title="超时时间"></a>超时时间</h4><p>出现一次传输超时，将Timeout加倍</p>
<h4 id="快速重传"><a href="#快速重传" class="headerlink" title="快速重传"></a>快速重传</h4><p><em><em>对已经正确到达的最后一个字节ACK进行确认</em></em>字节ACK进行确认**，即生成冗余ACK</p>
<blockquote>
<p>避免发送太多的冗余ACK，比如发送报文1到达，2丢失，$3,4,\cdots$等报文到达时均会导致冗余ACK，避免这种问题，对于发送方设置如下规则</p>
<blockquote>
<p>如果sender收到三个相同的冗余ACK，说明ACK之后的报文段已经丢失，执行快速重传</p>
</blockquote>
</blockquote>
<h4 id="差错恢复"><a href="#差错恢复" class="headerlink" title="差错恢复"></a>差错恢复</h4><blockquote>
<p>接收方并不会对乱序但正确到达的报文段逐个确认</p>
</blockquote>
<h4 id="流量控制"><a href="#流量控制" class="headerlink" title="流量控制"></a>流量控制</h4><ol>
<li><strong>发送方</strong><em><em><em><em>，接收窗口的大小告诉发送方</em></em>送方**接收方还可以接收多少报文于缓存区</em></em>**</li>
<li>接收窗口为0，接收方向发送方发送一个只包含一个字节数据的报文段，发送方确认并得知接收方无接收缓存，将自身阻塞，直到接受方清理部分缓存告知发送方可以继续发送</li>
</ol>
<h3 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h3><ol>
<li><p>客户端初始选择一个随机序号，作为TCP报文的头部序号字段，并设置头部SYN为1</p>
<blockquote>
<p>为何选择随机序号(客户端序号<code>client_isn,client_isn+1,client_isn+2</code>，服务端确认号<code>client_isn+1,client_isn+2</code>，服务端序号<code>server_isn,server_isn+1</code>)</p>
<p>有一种说法声称这种方式可以保护传输数据的大</p>
</blockquote>
</li>
<li><p><em><em>允许连接</em></em><em><em>允许连接</em></em><em><em>允许连接</em></em>*报文SYNACK</p>
</li>
<li><p><em><em>连接已经建立</em></em><em><em>连接已经建立</em></em><em><em>连接已经建立</em></em><em>连接已经建立*</em>，这个客户端到服务端的报文可以带上数据</p>
</li>
</ol>
<blockquote>
<p>端口号在网络通信中起到何种作用？能否多个进程监听同一个端口？</p>
<p><em><em>区分不同网络服务</em></em><em><em>区分不同网络服务</em></em><em>区分不同网络服务*</em>的作用，如果不用这种方法则必须在网络层中添加一个字段并约定不同服务对应的id，显然增加了设计协议的复杂度</p>
<blockquote>
<p>服务端线程池可能会采用单个服务-多线程监听同一端口的模式，这是利用并行资源提高性能</p>
</blockquote>
<p>什么是端口监听？端口的状态指的是什么？</p>
<blockquote>
<p>体系结构的角度监听更像是触发器，服务端/客户端状态转换随着握手的进行如图</p>
</blockquote>
<p><img src="https://s2.loli.net/2023/03/27/VygXpaqQLNZKnk9.png" alt="image-20230325115841930"></p>
<p><em><em>成功的TCP连接</em></em>P连接**</p>
<blockquote>
<p><em><em>需要考虑建立连接的报文丢失的情况</em></em><em><em>需要考虑建立连接的报文丢失的情况</em></em><em><em>需要考虑建立连接的报文丢失的情况</em></em>需要考虑建立连接的报文丢失的情况**</p>
</blockquote>
<p>考虑重复连接(连续多次发起建立连接的TCP报文)</p>
<blockquote>
<p>客户端发送一个建立连接报文<code>SYN,Seqnum=client_isn</code>，因为种种原因并未在指定时间内到达receiver，以致于client认为建立连接失败，再次发送建立连接报文<code>SYN,SeNum=client_isn_new</code>，但是第一个连接建立报文并未丢失，而是在第二个报文到达server之前到达并促使server发出<code>SYN,ACK,Acknum=client_isn+1,Seqnum=serve_isn</code></p>
<blockquote>
<p>这种情况也可能是因为服务端第二次握手ACK没能到达或者服务器宕机，这里假设旧的连接请求先到达，如果旧的请求后到达，已经建立的连接并不会产生任何反应</p>
</blockquote>
</blockquote>
<p><em><em>期望收到的SeqNum</em></em><strong>期望收到的SeqNum</strong>，第一次握手后客户端期望收到的SeqNum是<code>client_isn+1</code>，如果遇到了上面提到的重复建立连接的情况，旧的连接ACK包将会返回错误的<code>SeqNum</code>，而不是<code>client_isn_new+1</code>，此时</p>
<blockquote>
<p>客户端向服务端发送RST报文，断开旧的连接，转为新的连接返回ACK</p>
<blockquote>
<p>这貌似也能解释为什么每次建立连接都要随机选择一个序列号，都从0开始也无法区分新旧连接</p>
</blockquote>
<p>为什么不直接两次握手+传递数据，如果第二次返回的报文<code>Acknum</code>不正确则RST整个连接</p>
</blockquote>
<p><em><em>按序接收</em></em><em><em>按序接收</em></em><strong>按序接收</strong>数据包和去除冗余数据，只需要一次数据传递<code>Seqnum,server_isn</code>就可以同步服务端/客户端发送的第一个字节序号</p>
</blockquote>
<h3 id="TCP分段MSS"><a href="#TCP分段MSS" class="headerlink" title="TCP分段MSS"></a>TCP分段MSS</h3><p><em><em><em><em>最大长度不能超过MTU(1500字节)，MSS指的是</em></em>是**去除IP头部和TCP头部</em></em>CP头部**网络包最多容纳的TCP报文长度</p>
<blockquote>
<p><em><em>一个分片丢失，所有分片重传</em></em><em><em>一个分片丢失，所有分片重传</em></em><em><em>一个分片丢失，所有分片重传</em></em>，所有分片重传**</p>
<blockquote>
<p><em><em>连坐</em></em><em><em>连坐</em></em><em><em>连坐</em></em><em><em>连坐</em></em><em><em>连坐</em></em><em><em>连坐</em></em><em><em>连坐</em></em><em>连坐*</em></p>
<blockquote>
<p>为什么不在IP层加入重传机制？</p>
</blockquote>
</blockquote>
<p><em><em>避免IP重传产生的额外风险</em></em>产生的额外风险**，TCP将发送的信息分段，保证每次传输的数据大小不超过MSS，这样一个TCP报文和一个IP报文一一对应，不会有IP分片</p>
</blockquote>
<h2 id="Lab-2-Overview"><a href="#Lab-2-Overview" class="headerlink" title="Lab 2 Overview"></a>Lab 2 Overview</h2><p>之间我们实现了组装完毕的字节流对象<code>ByteStream</code>用于接收顺序到达的字节流，以及字节流重组器<code>StreamReassembler</code>，lab2要求实现TCP receiver，功能时将一个TCP segment写道<code>ByteStream</code>对象中，通过<code>segment_received()</code>方法接收TCP Segment </p>
<p>可靠数据传输协议receiver需要传递给sender如下信息</p>
<ol>
<li>第一个没有组装的byte index(Acknum)</li>
<li>窗口大小，发送的数据落在滑动窗口外会直接丢弃，落在窗口内则会缓存或写入<code>ByteStream</code></li>
</ol>
<h2 id="Lab2-in-details"><a href="#Lab2-in-details" class="headerlink" title="Lab2 in details"></a>Lab2 in details</h2><h3 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h3><h4 id="Acknowledgement"><a href="#Acknowledgement" class="headerlink" title="Acknowledgement"></a>Acknowledgement</h4><p>receiver告知sender下一个写入Bytestream的byte index</p>
<h4 id="Flow-control"><a href="#Flow-control" class="headerlink" title="Flow control"></a>Flow control</h4><p>sender被告知receiver希望收到的byte stream index范围(缓冲区)</p>
<h3 id="Seqno转换"><a href="#Seqno转换" class="headerlink" title="Seqno转换"></a>Seqno转换</h3><p><code>Reassembler push string</code>中index是64bit，TCP报文中index是32bits，64bit index不会出现overflow，使用32bit index需要避免以下潜在问题</p>
<ol>
<li>wrap around，即index自增到0</li>
<li>TCP序列起始于随机index(ISN)</li>
<li>一个TCP通讯的逻辑起始和结束byte index可能具有一个sequence number</li>
</ol>
<p>seqno保存在TCP报文的头部，注意SYN和FIN不和数据一起传递，给出的例子(ISN是$2^{32}-2$)</p>
<p><img src="C:\Users\Lenovo\AppData\Roaming\Typora\typora-user-images\image-20230328110305523.png" alt="image-20230328110305523"></p>
<p>三类index</p>
<ol>
<li>Sequence Number 是TCP报文头部传递的Seqno(<code>WrappingInt32</code>)</li>
<li>Absolute Sequence Number可以是64bits无符号数，可以看成byte在整个sequence中的绝对位置(<code>uint64_t</code>)</li>
<li>Stream index是不包含SYN的Absolute seqno</li>
</ol>
<p>一个segment的seqno比isn的seqno小会出现什么情况，比如seq = 0 absseq = $2^{32}-1$，它们相减的结果是1</p>
<p><img src="https://s2.loli.net/2023/03/31/rEqmMVfhBo5O6xb.png" alt="image-20230331120059790"></p>
<p>在<code>wrapping_integers.cc</code>中需要实现如下函数</p>
<ol>
<li><code>WrappingInt32 wrap(uint_64_t n,WrappingInt32 isn)</code></li>
</ol>
<p>给定byte相对于Initial Sequence Number的偏移n和isn，计算实际的Sequence Num absolute seqno $\to $ seqno</p>
<ol>
<li><code>uint64_t unwrap(WrappingInt32 n,WrappingInt32 isn,uint64_t checkpoint)</code></li>
</ol>
<p><em><em>循环index的情况</em></em><em><em>循环index的情况</em></em><em><em>循环index的情况</em></em><em><em>循环index的情况</em></em>dex的情况**，需要借助checkpoint选择最接近的index，比如isn=0，index=17，绝对偏移可能是$k\times 2^{32} + 17$ seqno $\to $ absolute seqno</p>
<h3 id="实现TCP-receiver"><a href="#实现TCP-receiver" class="headerlink" title="实现TCP receiver"></a>实现TCP receiver</h3><p>TCP双工通讯，意味着客户端和服务端都需要运行一个TCP receive，一个segment包括</p>
<p><img src="https://s2.loli.net/2023/03/31/Ip8GC6YtjyRrHLU.png" alt="image-20230331151729382"></p>
<p>TCP不包含Source IP/Destination IP，它只关心报文到达主机后交付给哪个上层应用</p>
<h4 id="Interface"><a href="#Interface" class="headerlink" title="Interface"></a>Interface</h4><ol>
<li><code>TCPReceiver(const size_t capacity);</code>初始化</li>
<li><code>void segment_received(const TCPSegment &amp;seg);</code>接受TCP报文段<code>seg</code></li>
<li><code>std::optional&lt;WrappingInt32&gt; ackno() const;</code>返回一个可能空的对象，仅在建立连接时调用，其它时候返回nullopt对象，返回stream中第一个byte index</li>
<li><code>size_t unassemble_bytes() const</code>返回尚未组装(乱序字节数)</li>
<li><code>size_t window_size() const</code>窗口大小需要发送给另一方</li>
</ol>
<p><em><em>打包</em></em><em><em>打包</em></em><em><em>打包</em></em><em><em>打包</em></em><em><em>打包</em></em><em><em>打包</em></em>包**，布尔值表示变量T是否为空，对于一个<code>std::optional&lt;T&gt;</code>对象</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">optional&lt;T&gt; val;</span><br></pre></td></tr></table></figure>
<p>两个方法</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">val.<span class="built_in">has_value</span>(); <span class="comment">// 判断是否有值</span></span><br><span class="line">val.<span class="built_in">value</span>(); <span class="comment">// 返回值，如果没有值将会产生异常</span></span><br></pre></td></tr></table></figure>
<h4 id="接收字节流segment-received"><a href="#接收字节流segment-received" class="headerlink" title="接收字节流segment_received()"></a>接收字节流<code>segment_received()</code></h4><p>peer收到一个segment调用，函数功能是</p>
<ol>
<li>设置ISN，如果segment用于建立连接需要为通讯选择32-bit ISN</li>
<li>将数据写道<code>StreamReassembler</code>，写入StreamReassembler的index需要从0开始</li>
<li>接收到FIN时传入eof</li>
</ol>
<h4 id="ackno"><a href="#ackno" class="headerlink" title="ackno()"></a>ackno()</h4><p>返回接收方期待接收的下一个字节流索引（前提是接收方初始化了ISN，否则返回空的optional）</p>
<h4 id="window-size"><a href="#window-size" class="headerlink" title="window_size()"></a><code>window_size()</code></h4><p>first unacdeptable index指的是Streamassemble对象大小，注意<code>Streamassemble</code>对象中可能包含尚未读取的部分，因此需要用<code>capacity</code>减去这一部分大小</p>
<h3 id="Receiver状态"><a href="#Receiver状态" class="headerlink" title="Receiver状态"></a>Receiver状态</h3><ol>
<li>LISTEN 尚未建立连接(等待segment中包含SYN)</li>
<li><code>SYN_RECV</code>建立连接（标志为头部包含SYN）需要发送一个SYN+ACK</li>
<li><code>ByteStream.input_end() == true</code>，代表一次连接结束</li>
</ol>
<blockquote>
<p>注意：初始化随机序号是sender的工作</p>
</blockquote>
<h3 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h3><h4 id="SYN需要占据一个Byte"><a href="#SYN需要占据一个Byte" class="headerlink" title="SYN需要占据一个Byte"></a>SYN需要占据一个Byte</h4><p>建立连接的过程客户端向服务端发送一个报文，格式为</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SYN+client_isn</span><br></pre></td></tr></table></figure>
<p>这一过程不携带数据，服务端回应这个报文的ACK num是<code>client_isn + 1</code>，但是假设发送一个ACK报文(SYN设置为False)给peer，且seq num为<code>seqno</code>，则peer回复这个ACK报文的ACK no为<code>seqno</code></p>
<h4 id="调用unwrap和wrap"><a href="#调用unwrap和wrap" class="headerlink" title="调用unwrap和wrap"></a>调用unwrap和wrap</h4><p><code>segment_receive</code>方法需要调用<code>push_substring(string &amp;,uint64_t,eof);</code>写入字节流，其中第二个参数<code>uint64_t</code>通过unwrap获得</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">unwrap</span>(WrappingInt32 n,WrappingInt32 isn,<span class="type">uint64_t</span> checkpoint)</span><br></pre></td></tr></table></figure>
<p>checkpoint是输入segment最后一个字节流index，isn需要在接收时保存</p>
<h3 id="TCP-window"><a href="#TCP-window" class="headerlink" title="TCP window"></a>TCP window</h3><p>是一个保存应用程序尚未处理数据的buffer(应用处理数据能力/数据流到达速度不匹配)</p>
<blockquote>
<p><em><em>已经组装但是没有写入ByteStream</em></em><em><em>已经组装但是没有写入ByteStream</em></em><strong>已经组装但是没有写入ByteStream</strong>，之前实现有误，没有考虑ByteStream满的情况</p>
</blockquote>
<h3 id="获取Header信息"><a href="#获取Header信息" class="headerlink" title="获取Header信息"></a>获取Header信息</h3><p>通过</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">seg.<span class="built_in">header</span>();</span><br><span class="line">sef.<span class="built_in">payload</span>();</span><br></pre></td></tr></table></figure>
<p>获取报文段头部和数据负载，头部结构体包含如下信息</p>
<ol>
<li><code>bool syn</code>建立连接的标志字段，如下情况下可能收到这个字段为True的Segment<ol>
<li>服务端接收到客户端发来的请求建立报文，此时需要确定服务端本身的ISN</li>
<li>客户端收到服务端带来的确认第一次握手报文(SYN+ACK)</li>
</ol>
</li>
<li><code>bool ack</code>意味着允许连接，存在于两种情况<ol>
<li>服务端发送给客户端允许连接</li>
<li><em><em>此时workload可能携带数据</em></em>时workload可能携带数据**</li>
</ol>
</li>
<li><code>INT32 seqno</code>报文序列号</li>
<li><code>IT32 ackno</code>应答号</li>
</ol>
<h3 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h3><h4 id="维护发送字段的序列号"><a href="#维护发送字段的序列号" class="headerlink" title="维护发送字段的序列号"></a>维护发送字段的序列号</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::optional&lt;WarpingInt32&gt; _isn;</span><br></pre></td></tr></table></figure>
<p>如果<code>_isn.has_value()</code>为false，意味着ISN没有被初始化，初始化写成</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(header.syn &amp;&amp; !_isn.<span class="built_in">has_value</span>())&#123;</span><br><span class="line">    <span class="comment">// initial _isn</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="维护receiver状态"><a href="#维护receiver状态" class="headerlink" title="维护receiver状态"></a>维护receiver状态</h3><p>设置<code>syn_flag</code>标志位，如果为true代表并未建立连接，接收到syn标志位为true的包则建立连接</p>
<ol>
<li>修改<code>syn_flag</code>状态</li>
<li>记录建立连接的sequence index</li>
</ol>
<blockquote>
<p>初始化isn由sender完成，采用一个<code>optional</code>class记录</p>
</blockquote>
<p>注意syn本身也会占用一个index，如果建立连接后传输中不带有任何数据则不会占据额外的index</p>
<blockquote>
<p>需要保存syn数据包携带的数据(不是特别明白，按照三次握手的要求不是第三次握手才会携带数据吗)</p>
</blockquote>
<p>通讯终止：head.fin为true则通信终止，因此需要将<code>head.fin</code>传递给push_substring的tag位</p>
<p>Reassemble中可能包含部分因为<code>ByteStream capacity</code>受限而没写入Bytestream的数据，因此需要统计这部分占据的大小</p>

        
    

    
</div>


                

                <!-- Post Comments -->
                
                    
    <!-- 使用 DISQUS -->
<div id="disqus-comment">
    <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'http://gaoustcer.github.io/2023/04/25/TCP-Receiver-CS144/';  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = 'http://gaoustcer.github.io/2023/04/25/TCP-Receiver-CS144/'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
</script>
<script type="text/ls-javascript" id="disqus-thread-script">
    queue.offer(function() {
            (function() { // DON'T EDIT BELOW THIS LINE
                var d = document;
                var s = d.createElement('script');
                s.src = '//.disqus.com/embed.js';
                s.setAttribute('data-timestamp', + new Date());
                (d.head || d.body).appendChild(s);
            })();
        });
</script>

</div>
<style>
    #disqus-comment{
        background-color: #eee;
        padding: 2pc;
    }
</style>

                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2023/04/28/Offline-RL-TD3-BC/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            新篇
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2023/04/25/TCP-IP-Protocol/" id="post_nav-older" class="next-content">
            旧篇
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="Gaoustcer's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        kd193104@mail.ustc.edu.cn
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="#" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                主页
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    归档
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2023/12/">十二月 2023<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2023/11/">十一月 2023<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/archives/2023/10/">十月 2023<span class="sidebar_archives-count">7</span></a></li><li><a class="sidebar_archives-link" href="/archives/2023/09/">九月 2023<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2023/08/">八月 2023<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/archives/2023/07/">七月 2023<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2023/06/">六月 2023<span class="sidebar_archives-count">5</span></a></li><li><a class="sidebar_archives-link" href="/archives/2023/05/">五月 2023<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2023/04/">四月 2023<span class="sidebar_archives-count">23</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    

    <!-- Pages  -->
    
        <li>
            <a href="/about" title="About">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                About
            </a>
        </li>
        
    
        <li>
            <a href="/papers" title="papers">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                papers
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                文章总数
                <span class="sidebar-badge">60</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->

    <div class="sidebar-divider"></div>


<!-- Theme Material -->

    <a href="https://github.com/bollnh/hexo-theme-material"  class="sidebar-footer-text-a" target="_blank">
        <div class="sidebar-text mdl-button mdl-js-button mdl-js-ripple-effect sidebar-footer-text-div" data-upgraded=",MaterialButton,MaterialRipple">
            主题 - Material
            <span class="sidebar-badge badge-circle">i</span>
        </div>
    </a>


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/twitter" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    
        <a href="https://www.facebook.com/facebook" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-facebook">
                <span class="visuallyhidden">Facebook</span>
            </button><!--
     --></a>
    

    <!-- Google + -->
    
        <a href="https://www.google.com/" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-gplus">
                <span class="visuallyhidden">Google Plus</span>
            </button><!--
     --></a>
    

    <!-- Weibo -->
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    

    <!-- V2EX -->
    

    <!-- Segmentfault -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;<span year></span>&nbsp;Hexo
            
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/bollnh/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import JS File -->

    <script>lsloader.load("lazyload_js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==", true)</script>



    <script>lsloader.load("js_js","/js/js.min.js?Bn9UzEm8RrBSxqyZB0zPjA==", true)</script>



    <script>lsloader.load("np_js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==", true)</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>









   <!-- 使用 DISQUS js 代码 -->
<script id="dsq-count-scr" src="//.disqus.com/count.js" async></script>





<!-- UC Browser Compatible -->
<!-- <script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('
<link rel="stylesheet" href="/css/uc.css">
');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script> -->

<!-- Import prettify js  -->



<!-- Window Load -->
<!-- add class for prettify -->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });

    
    
</script>

<!-- MathJax Load-->


<!-- Bing Background -->


<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Custom Footer -->



<script>
    var copyrightNow = new Date().getFullYear();
    var textContent = document.querySelector('span[year]')

    copyrightSince = 0000;
    if (copyrightSince === copyrightNow||copyrightSince === 0000) {
        textContent.textContent = copyrightNow
    } else {
        textContent.textContent = copyrightSince + ' - ' + copyrightNow
    }

    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.5.6 | https://github.com/bollnh/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
    for (var i = 0; i < all.length; ++i)
        all[i].SourceElement().parentNode.className += ' has-jax';
});
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<!--<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->

</body>
    
</html>
